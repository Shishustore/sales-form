const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNLdBkikMHWtIs9OmwMZH0__DoWj-8RVZ77QUM8CkrB3yotTP7LMqSIW9pRAmYUYH4/exec';
let products = [];
let productMap = {};
let orderItems = [];

// Fetch products from Google Sheets
fetch(SCRIPT_URL)
    .then(response => response.json())
    .then(data => {
        console.log('Fetched products:', data);
        products = data;
        productMap = {};
        products.forEach(p => {
            if (!productMap[p.name]) {
                productMap[p.name] = [];
            }
            productMap[p.name].push({size: p.size, price: p.price});
        });
        console.log('Product map:', productMap);
    })
    .catch(error => console.error('Error fetching products:', error));

// Search functionality
document.getElementById('product-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const resultsDiv = document.getElementById('search-results');
    if (!productMap || Object.keys(productMap).length === 0) {
        resultsDiv.innerHTML = '<div>No products available</div>';
        console.log('Search attempted, but productMap is empty');
        return;
    }
    const matchingProducts = Object.keys(productMap).filter(name => name.toLowerCase().includes(searchTerm));
    console.log('Search term:', searchTerm, 'Matching products:', matchingProducts);
    resultsDiv.innerHTML = matchingProducts.length > 0 
        ? matchingProducts.map(name => `<div onclick="selectProduct('${name}')">${name}</div>`).join('')
        : '<div>No matching products found</div>';
});

// Select product
function selectProduct(name) {
    document.getElementById('product-search').value = name;
    document.getElementById('search-results').innerHTML = '';
    const sizes = productMap[name];
    const sizeSelect = document.getElementById('size-select');
    sizeSelect.innerHTML = '<option value="">Select Size</option>' + sizes.map(size => `<option value="${size.size}" data-price="${size.price}">${size.size} - ${size.price}</option>`).join('');
}

// Add to order
document.getElementById('add-to-order').addEventListener('click', function() {
    const productName = document.getElementById('product-search').value;
    const sizeSelect = document.getElementById('size-select');
    const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];
    const size = selectedOption.value;
    const price = parseFloat(selectedOption.getAttribute('data-price'));
    if (!productName || !size) {
        alert('Please select a product and size.');
        return;
    }
    orderItems.push({productName, size, price});
    updateOrderSummary();
});

// Update order summary
function updateOrderSummary() {
    const orderItemsDiv = document.getElementById('order-items');
    orderItemsDiv.innerHTML = orderItems.map((item, index) => `<div class="order-item">${item.productName}, ${item.size} - ${item.price} <button class="remove-btn" onclick="removeItem(${index})">Remove</button></div>`).join('');
    const subtotal = orderItems.reduce((sum, item) => sum + item.price, 0);
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    updateTotal();
}

// Remove item
function removeItem(index) {
    orderItems.splice(index, 1);
    updateOrderSummary();
}

// Update total when discount changes
document.getElementById('discount').addEventListener('input', updateTotal);

function updateTotal() {
    const subtotal = parseFloat(document.getElementById('subtotal').textContent);
    const discountPercent = parseFloat(document.getElementById('discount').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const total = subtotal - discountAmount;
    document.getElementById('total').textContent = total.toFixed(2);
}

// Confirm order
document.getElementById('confirm-order').addEventListener('click', function() {
    const paymentMethod = document.getElementById('payment-method').value;
    if (orderItems.length === 0 || !paymentMethod) {
        alert('Please add products and select payment method.');
        return;
    }
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const total = parseFloat(document.getElementById('total').textContent);
    const remarks = document.getElementById('remarks').value;
    const data = {
        products: orderItems,
        discount: discount,
        total: total,
        paymentMethod: paymentMethod,
        remarks: remarks
    };
    fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        alert('Order ' + result.orderNumber + ' created successfully!');
        orderItems = [];
        document.getElementById('order-items').innerHTML = '';
        document.getElementById('subtotal').textContent = '0';
        document.getElementById('discount').value = '';
        document.getElementById('total').textContent = '0';
        document.getElementById('payment-method').value = '';
        document.getElementById('product-search').value = '';
        document.getElementById('size-select').innerHTML = '<option value="">Select Size</option>';
        document.getElementById('remarks').value = '';
    })
    .catch(error => console.error('Error submitting order:', error));
});
